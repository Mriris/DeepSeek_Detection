<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>翻译性能监控</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .gauge-container {
            position: relative;
            width: 100%;
            height: 150px;
        }
        .progress {
            height: 25px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 600;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .gpu-temp {
            font-size: 28px;
            font-weight: bold;
        }
        .gpu-power {
            font-size: 22px;
            font-weight: 600;
        }
        #status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
        }
        .connected {
            background-color: #28a745;
        }
        .disconnected {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center">翻译性能实时监控 
                    <small class="text-muted">
                        <span id="status-indicator" class="disconnected"></span>
                        <span id="connection-status">正在连接...</span>
                    </small>
                </h1>
            </div>
        </div>

        <div class="row">
            <!-- GPU信息 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">GPU状态 <span id="gpu-name" class="float-end"></span></h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h5>GPU使用率</h5>
                                <div class="progress">
                                    <div id="gpu-util-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                         style="width: 0%">0%</div>
                                </div>
                                
                                <h5>GPU内存使用</h5>
                                <div class="progress">
                                    <div id="gpu-mem-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                         style="width: 0%">0%</div>
                                </div>
                                <div class="text-center">
                                    <span id="gpu-mem-text">0 MB / 0 MB</span>
                                </div>
                            </div>
                            <div class="col-6 text-center">
                                <div class="mb-3">
                                    <div class="stat-label">温度</div>
                                    <div class="gpu-temp"><span id="gpu-temp">0</span>°C</div>
                                </div>
                                <div>
                                    <div class="stat-label">功率</div>
                                    <div class="gpu-power"><span id="gpu-power">0</span> W</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 系统信息 -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">系统状态</h4>
                    </div>
                    <div class="card-body">
                        <h5>CPU使用率</h5>
                        <div class="progress">
                            <div id="cpu-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                 role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                 style="width: 0%">0%</div>
                        </div>
                        
                        <h5>内存使用</h5>
                        <div class="progress">
                            <div id="mem-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                 style="width: 0%">0%</div>
                        </div>
                        <div class="text-center">
                            <span id="mem-text">0 GB / 0 GB</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 性能图表 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">性能监控图表</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 翻译统计 -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">翻译进度</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-9">
                                <h5>总体进度</h5>
                                <div class="progress">
                                    <div id="translation-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                         style="width: 0%">0%</div>
                                </div>
                                <div class="text-center mb-3">
                                    <span id="translation-text">0 / 0 条文本处理完成</span>
                                </div>
                                
                                <div class="row">
                                    <div class="col-6">
                                        <div class="stat-label">当前批次</div>
                                        <div class="stat-value"><span id="current-batch">0</span> / <span id="total-batches">0</span></div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-label">平均处理时间</div>
                                        <div class="stat-value"><span id="avg-time">0</span> 秒/条</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="stat-label">已运行时间</div>
                                <div class="stat-value" id="elapsed-time">0:00:00</div>
                                <div class="stat-label mt-2">预计剩余时间</div>
                                <div class="stat-value" id="eta-time">0:00:00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加翻译内容显示部分 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">当前翻译内容 <small class="text-muted" id="translation-time"></small></h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>源文本 <small class="text-muted">(批次: <span id="current-batch-index">0</span>, 文本: <span id="current-text-index">0</span>)</small></h5>
                            <div class="border p-3 bg-light" style="min-height: 150px; max-height: 200px; overflow-y: auto;" id="source-text">
                                <em class="text-muted">等待翻译...</em>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>翻译结果 <small class="text-muted" id="processing-time"></small></h5>
                            <div class="border p-3 bg-light" style="min-height: 150px; max-height: 200px; overflow-y: auto;" id="translated-text">
                                <em class="text-muted">等待翻译...</em>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 性能图表初始化
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        // 用于存储历史数据
        const historyData = {
            timestamps: [],
            gpuUtil: [],
            gpuMem: [],
            cpuUtil: [],
            memoryUtil: []
        };
        
        // 最大数据点数
        const MAX_DATA_POINTS = 60;
        
        // 创建图表
        const performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'GPU利用率',
                        data: [],
                        borderColor: 'rgb(0, 123, 255)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        pointRadius: 0
                    },
                    {
                        label: 'GPU内存占用',
                        data: [],
                        borderColor: 'rgb(255, 193, 7)',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        pointRadius: 0
                    },
                    {
                        label: 'CPU利用率',
                        data: [],
                        borderColor: 'rgb(23, 162, 184)',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        pointRadius: 0
                    },
                    {
                        label: '内存占用',
                        data: [],
                        borderColor: 'rgb(40, 167, 69)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '时间'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: '百分比 (%)'
                        },
                        min: 0,
                        max: 100
                    }
                },
                animation: {
                    duration: 0
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            }
        });
        
        // 格式化时间函数
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            seconds %= 3600;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            
            return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // 更新图表数据
        function updateChart(timestamp, gpuUtil, gpuMem, cpuUtil, memoryUtil) {
            // 添加新数据
            historyData.timestamps.push(new Date());
            historyData.gpuUtil.push(gpuUtil);
            historyData.gpuMem.push(gpuMem);
            historyData.cpuUtil.push(cpuUtil);
            historyData.memoryUtil.push(memoryUtil);
            
            // 保持数组大小在MAX_DATA_POINTS以内
            if (historyData.timestamps.length > MAX_DATA_POINTS) {
                historyData.timestamps.shift();
                historyData.gpuUtil.shift();
                historyData.gpuMem.shift();
                historyData.cpuUtil.shift();
                historyData.memoryUtil.shift();
            }
            
            // 更新图表标签
            const timeLabels = historyData.timestamps.map(date => {
                return date.getHours().toString().padStart(2, '0') + ':' + 
                       date.getMinutes().toString().padStart(2, '0') + ':' + 
                       date.getSeconds().toString().padStart(2, '0');
            });
            
            performanceChart.data.labels = timeLabels;
            performanceChart.data.datasets[0].data = historyData.gpuUtil;
            performanceChart.data.datasets[1].data = historyData.gpuMem;
            performanceChart.data.datasets[2].data = historyData.cpuUtil;
            performanceChart.data.datasets[3].data = historyData.memoryUtil;
            
            performanceChart.update();
        }
        
        // 更新UI函数
        function updateUI(data) {
            // 更新状态指示器
            const statusIndicator = document.getElementById('status-indicator');
            const connectionStatus = document.getElementById('connection-status');
            statusIndicator.className = 'connected';
            connectionStatus.textContent = '已连接';
            
            // 更新GPU信息
            const gpuInfo = data.gpu_info;
            if (gpuInfo && !gpuInfo.error) {
                // 更新GPU名称
                document.getElementById('gpu-name').textContent = gpuInfo.name;
                
                // 更新GPU利用率
                const gpuUtilProgress = document.getElementById('gpu-util-progress');
                gpuUtilProgress.style.width = `${gpuInfo.utilization}%`;
                gpuUtilProgress.textContent = `${gpuInfo.utilization}%`;
                gpuUtilProgress.setAttribute('aria-valuenow', gpuInfo.utilization);
                
                // 更新GPU内存
                const gpuMemProgress = document.getElementById('gpu-mem-progress');
                gpuMemProgress.style.width = `${gpuInfo.memory_percent}%`;
                gpuMemProgress.textContent = `${gpuInfo.memory_percent.toFixed(1)}%`;
                gpuMemProgress.setAttribute('aria-valuenow', gpuInfo.memory_percent);
                
                // 更新GPU内存文本
                document.getElementById('gpu-mem-text').textContent = 
                    `${gpuInfo.memory_used_mb.toFixed(0)} MB / ${gpuInfo.memory_total_mb.toFixed(0)} MB`;
                
                // 更新温度和功率
                document.getElementById('gpu-temp').textContent = gpuInfo.temperature;
                document.getElementById('gpu-power').textContent = gpuInfo.power_usage.toFixed(1);
            }
            
            // 更新系统信息
            const sysInfo = data.system_info;
            if (sysInfo && !sysInfo.error) {
                // 更新CPU利用率
                const cpuProgress = document.getElementById('cpu-progress');
                cpuProgress.style.width = `${sysInfo.cpu_percent}%`;
                cpuProgress.textContent = `${sysInfo.cpu_percent}%`;
                cpuProgress.setAttribute('aria-valuenow', sysInfo.cpu_percent);
                
                // 更新内存利用率
                const memProgress = document.getElementById('mem-progress');
                memProgress.style.width = `${sysInfo.memory_percent}%`;
                memProgress.textContent = `${sysInfo.memory_percent}%`;
                memProgress.setAttribute('aria-valuenow', sysInfo.memory_percent);
                
                // 更新内存文本
                document.getElementById('mem-text').textContent = 
                    `${sysInfo.memory_used_gb.toFixed(1)} GB / ${sysInfo.memory_total_gb.toFixed(1)} GB`;
            }
            
            // 更新翻译统计
            const translationStats = data.translation_stats;
            if (translationStats) {
                // 计算进度百分比
                let progress = 0;
                if (translationStats.total_texts > 0) {
                    progress = (translationStats.processed_texts / translationStats.total_texts) * 100;
                }
                
                // 更新进度条
                const translationProgress = document.getElementById('translation-progress');
                translationProgress.style.width = `${progress}%`;
                translationProgress.textContent = `${progress.toFixed(1)}%`;
                translationProgress.setAttribute('aria-valuenow', progress);
                
                // 更新文本处理统计
                document.getElementById('translation-text').textContent = 
                    `${translationStats.processed_texts} / ${translationStats.total_texts} 条文本处理完成`;
                
                // 更新批次信息
                document.getElementById('current-batch').textContent = translationStats.current_batch;
                document.getElementById('total-batches').textContent = translationStats.total_batches;
                
                // 更新平均处理时间
                document.getElementById('avg-time').textContent = translationStats.avg_time_per_text.toFixed(3);
                
                // 计算已运行时间
                const elapsedTime = Math.floor((new Date() - new Date(data.timestamp * 1000)) / 1000);
                document.getElementById('elapsed-time').textContent = formatTime(elapsedTime);
                
                // 计算预计剩余时间
                let etaTime = 0;
                if (translationStats.avg_time_per_text > 0 && translationStats.total_texts > translationStats.processed_texts) {
                    etaTime = (translationStats.total_texts - translationStats.processed_texts) * translationStats.avg_time_per_text;
                }
                document.getElementById('eta-time').textContent = formatTime(etaTime);
            }
            
            // 更新当前翻译内容
            const currentTranslation = data.current_translation;
            if (currentTranslation) {
                // 更新源文本
                const sourceTextElement = document.getElementById('source-text');
                if (currentTranslation.source_text) {
                    sourceTextElement.innerHTML = `<pre>${escapeHtml(currentTranslation.source_text)}</pre>`;
                } else {
                    sourceTextElement.innerHTML = `<em class="text-muted">等待翻译...</em>`;
                }
                
                // 更新翻译结果
                const translatedTextElement = document.getElementById('translated-text');
                if (currentTranslation.translated_text) {
                    translatedTextElement.innerHTML = `<pre>${escapeHtml(currentTranslation.translated_text)}</pre>`;
                } else if (currentTranslation.source_text) {
                    translatedTextElement.innerHTML = `<em class="text-muted">正在翻译中...</em>`;
                } else {
                    translatedTextElement.innerHTML = `<em class="text-muted">等待翻译...</em>`;
                }
                
                // 更新批次和文本索引
                document.getElementById('current-batch-index').textContent = currentTranslation.batch_index;
                document.getElementById('current-text-index').textContent = currentTranslation.text_index;
                
                // 更新处理时间
                if (currentTranslation.processing_time > 0) {
                    document.getElementById('processing-time').textContent = 
                        `(处理时间: ${currentTranslation.processing_time.toFixed(3)}秒)`;
                } else {
                    document.getElementById('processing-time').textContent = '';
                }
                
                // 更新翻译时间
                const now = new Date();
                document.getElementById('translation-time').textContent = 
                    `(${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')})`;
            }
            
            // 更新图表
            if (gpuInfo && !gpuInfo.error && sysInfo && !sysInfo.error) {
                updateChart(
                    data.timestamp,
                    gpuInfo.utilization,
                    gpuInfo.memory_percent,
                    sysInfo.cpu_percent,
                    sysInfo.memory_percent
                );
            }
        }
        
        // HTML转义函数，防止XSS攻击
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 设置事件源
        const eventSource = new EventSource('/api/stream');
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateUI(data);
        };
        
        eventSource.onerror = function() {
            const statusIndicator = document.getElementById('status-indicator');
            const connectionStatus = document.getElementById('connection-status');
            statusIndicator.className = 'disconnected';
            connectionStatus.textContent = '连接断开，尝试重新连接...';
        };
        
        // 页面加载时获取初始数据
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                updateUI(data);
            })
            .catch(error => {
                console.error('获取初始数据失败:', error);
            });
    </script>
</body>
</html> 