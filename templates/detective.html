{% extends 'base.html' %}

{% block content %}
<!-- Hero Section -->
<section id="hero" class="hero section dark-background">
    <div class="container">
        <div class="row gy-4">
            <!-- 左侧，上传文件和操作按钮 -->
            <div class="col-lg-6 order-2 order-lg-1 d-flex flex-column justify-content-center" data-aos="zoom-out">
                <h1>VULNEX</h1>
                <p>通过深度学习模型分析代码中的潜在安全漏洞</p>

                <!-- 文件上传表单 -->
                <form action="/detect" method="POST" enctype="multipart/form-data" id="detect-form"
                      class="upload-form d-flex flex-column align-items-center justify-content-center">
                    <div class="form-group w-100 d-flex">
                        <input type="file" name="json_file" id="json-upload" accept=".json"
                               class="form-control w-50">
                    </div>
                </form>

                <!-- 按钮 -->
                <div class="d-flex mt-3">
                    <a href="javascript:void(0);" class="btn-get-started me-3" id="action-btn">确定选择文件</a>
                </div>
            </div>
            <!-- 显示检测结果 -->
            <div id="detection-result" style="margin-top: 20px; color: #fff;"></div>


            <!-- 右侧，示意图（可以用任何展示漏洞检测结果的图像或保留默认） -->
            <div class="col-lg-6 order-1 order-lg-2 hero-img" data-aos="zoom-out" data-aos-delay="200">
                <img id="image-display" src="../static/assets/img/hero-img.png" class="img-fluid animated"
                     alt="示意图">
                <!-- 增强后的图像，默认隐藏，改为显示检测结果 -->
                <img id="enhanced-image-display" src="" style="margin-left: 20px;" class="img-fluid animated d-none"
                     alt="检测结果">
            </div>
        </div>
    </div>
</section><!-- /Hero Section -->
<!-- Clients Section -->
<section id="clients" class="clients section light-background">

    <div class="container" data-aos="zoom-in">

        <div class="swiper init-swiper">
            <script type="application/json" class="swiper-config">
                {
                    "loop": true,
                    "speed": 600,
                    "autoplay": {
                        "delay": 5000
                    },
                    "slidesPerView": "auto",
                    "pagination": {
                        "el": ".swiper-pagination",
                        "type": "bullets",
                        "clickable": true
                    },
                    "breakpoints": {
                        "320": {
                            "slidesPerView": 2,
                            "spaceBetween": 40
                        },
                        "480": {
                            "slidesPerView": 3,
                            "spaceBetween": 60
                        },
                        "640": {
                            "slidesPerView": 4,
                            "spaceBetween": 80
                        },
                        "992": {
                            "slidesPerView": 5,
                            "spaceBetween": 120
                        },
                        "1200": {
                            "slidesPerView": 6,
                            "spaceBetween": 120
                        }
                    }
                }
            </script>
            <div class="swiper-wrapper align-items-center">
                <div class="swiper-slide"><img src="../static/assets/img/clients/client-1.png" class="img-fluid"
                                               alt=""></div>
                <div class="swiper-slide"><img src="../static/assets/img/clients/client-2.png" class="img-fluid"
                                               alt=""></div>
                <div class="swiper-slide"><img src="../static/assets/img/clients/client-3.png" class="img-fluid"
                                               alt=""></div>
                <div class="swiper-slide"><img src="../static/assets/img/clients/client-4.png" class="img-fluid"
                                               alt=""></div>
                <div class="swiper-slide"><img src="../static/assets/img/clients/client-5.png" class="img-fluid"
                                               alt=""></div>
                <div class="swiper-slide"><img src="../static/assets/img/clients/client-6.png" class="img-fluid"
                                               alt=""></div>
                <div class="swiper-slide"><img src="../static/assets/img/clients/client-7.png" class="img-fluid"
                                               alt=""></div>
                <div class="swiper-slide"><img src="../static/assets/img/clients/client-8.png" class="img-fluid"
                                               alt=""></div>
            </div>
        </div>

    </div>

</section><!-- /Clients Section -->
<script>
    let currentStep = 'select';

    document.getElementById('action-btn').addEventListener('click', function (event) {
        event.preventDefault();

        if (currentStep === 'select') {
            handleFileUpload();
        } else if (currentStep === 'detect') {
            startDetection();
        } else if (currentStep === 'reset') {
            // 第三次点击“重置”
            resetPage();
        }
    });

    function startDetection() {
        const formData = new FormData(document.getElementById('detect-form'));

        // 调试：查看表单数据是否成功提交
        console.log('上传的表单数据:', formData);

        fetch('/detect', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                console.log('服务器响应:', response);  // 调试：检查响应
                return response.json();
            })
            .then(data => {
                console.log('后端返回的数据:', data);  // 调试：输出返回的 JSON 数据

                if (data.result) {
                    let resultContent = data.result;

                    // 提取 <think> 后的内容
                    const thinkStart = resultContent.indexOf('<think>');
                    const thinkEnd = resultContent.indexOf('</think>');

                    // 调试：检查原始内容及其格式
                    console.log('原始返回结果:', resultContent);
                    if (thinkStart !== -1 && thinkEnd !== -1) {
                        resultContent = resultContent.slice(thinkEnd + '</think>'.length);  // 获取 <think> 标签后的内容
                        // console.log('去掉 <think> 标签后的内容:', resultContent);  // 调试：去掉 <think> 后的内容
                    }

                    // 检查 marked 是否是函数
                    console.log('marked:', marked);
                    if (typeof marked !== 'function') {
                        console.error('marked.js 没有正确加载，marked 不是一个函数');
                    } else {
                        // 使用 marked.js 将 Markdown 转换为 HTML
                        const htmlContent = marked(resultContent);

                        // 调试：输出转换后的 HTML 内容
                        console.log('转换后的 HTML:', htmlContent);

                        // 确保我们正在将 HTML 内容插入到正确的元素
                        const detectionResultElement = document.getElementById('detection-result');
                        if (detectionResultElement) {
                            detectionResultElement.innerHTML = htmlContent;  // 将 HTML 插入页面
                            console.log('内容已成功插入到页面中');
                        } else {
                            console.error('未找到 #detection-result 元素');
                        }

                        // 修改按钮为“重置”
                        document.getElementById('action-btn').textContent = '重置';
                        currentStep = 'reset';  // 更新按钮状态
                    }
                } else {
                    console.error("未返回漏洞检测结果");
                }
            })
            .catch(error => {
                console.error('检测过程中出错:', error);
            });
    }


    // 处理文件上传并显示上传的文件
    function handleFileUpload() {
        const fileInput = document.getElementById('json-upload');
        const file = fileInput.files[0];

        if (file) {
            // 显示上传的文件名
            const reader = new FileReader();
            reader.onload = function (e) {
                console.log('文件成功上传并读取。');

                // 更新显示文本区域（如果需要显示文件内容，可以在这里进行）
                document.getElementById('file-name').textContent = "已选择文件: " + file.name;
            };
            reader.readAsDataURL(file);

            // 修改按钮为“开始检测”
            document.getElementById('action-btn').textContent = '开始检测';
            currentStep = 'detect';  // 更新按钮状态
        } else {
            alert("请选择一个文件进行上传！");
        }
    }

    // 刷新页面
    function resetPage() {
        window.location.reload();  // 通过重载页面实现“重置”
    }

</script>
{% endblock %}
