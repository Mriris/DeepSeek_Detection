{% extends 'base.html' %}

{% block content %}
<!-- Hero Section -->
<section id="hero" class="hero section dark-background">
    <div class="container">
        <div class="row gy-4">
            <!-- 左侧，上传文件和操作按钮 -->
            <div class="col-lg-6 order-2 order-lg-1 d-flex flex-column justify-content-center" data-aos="zoom-out">
                <h1>VULNEX</h1>
                <p>通过深度学习模型分析代码中的潜在安全漏洞</p>

                <!-- 文件上传表单 -->
                <form action="/detect" method="POST" enctype="multipart/form-data" id="detect-form"
                      class="upload-form d-flex flex-column align-items-center justify-content-center">
                    <div class="form-group w-100 d-flex">
                        <input type="file" name="bin_file" id="bin-upload" accept=".bin, .exe, .elf"
                               class="form-control w-50">
                    </div>
                </form>

                <!-- 按钮 -->
                <div class="d-flex mt-3">
                    <a href="javascript:void(0);" class="btn-get-started me-3" id="action-btn">确定选择文件</a>
                </div>
            </div>
            <!-- 显示检测结果 -->
            <div id="detection-result" style="margin-top: 20px; color: #fff;"></div>
            <!-- 新增：显示漏洞分析结果 -->
            <div id="analysis-result" style="margin-top: 20px; color: #fff;"></div>
            <!-- 右侧，示意图（可以用任何展示漏洞检测结果的图像或保留默认） -->
            <div class="col-lg-6 order-1 order-lg-2 hero-img" data-aos="zoom-out" data-aos-delay="200">
                <img id="image-display" src="../static/assets/img/hero-img.png" class="img-fluid animated"
                     alt="示意图">
                <!-- 增强后的图像，默认隐藏，改为显示检测结果 -->
                <img id="enhanced-image-display" src="" style="margin-left: 20px;" class="img-fluid animated d-none"
                     alt="检测结果">
            </div>
        </div>
    </div>
</section><!-- /Hero Section -->

<script>
    let currentStep = 'select';
    let resultData = [];  // 用于保存检测结果数据

    document.getElementById('action-btn').addEventListener('click', function (event) {
        event.preventDefault();

        if (currentStep === 'select') {
            handleFileUpload();
        } else if (currentStep === 'detect') {
            startDetection();
        } else if (currentStep === 'reset') {
            // 第三次点击“重置”
            resetPage();
        }
    });

    // 启动检测
    function startDetection() {
        const formData = new FormData(document.getElementById('detect-form'));

        fetch('/detect', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log("收到的完整数据:", data);

                if (data.error) {
                    console.error("错误:", data.error);
                    alert(data.error || "发生了未知错误");
                } else {
                    let csvData = data.csv;
                    console.log("收到的 csv 数据:", csvData);

                    if (!Array.isArray(csvData)) {
                        console.error("data.csv 不是数组，数据格式错误");
                        alert("数据格式错误");
                        return;
                    }

                    // 展示表格
                    displayResults(csvData);

                    // 按钮改为重置
                    document.getElementById('action-btn').textContent = '重置';
                    currentStep = 'reset';

                    // 如果选中了某个地址，调用后端进行漏洞分析
                    if (selectedAddress) {
                        analyzeVulnerability(selectedAddress);
                    }
                }
            })
            .catch(error => {
                console.error('检测过程中出错:', error);
                alert('检测过程中出错，请稍后再试');
            });
    }

    function analyzeVulnerability(address) {
        console.log("开始分析漏洞:", address);

        fetch(`/analyze/${address}`, {
            method: 'GET'
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("分析失败:", data.error);
                    alert("分析失败");
                } else {
                    console.log("分析结果:", data.result);

                    // 提取 <think> 和外部 Markdown 内容
                    let resultContent = data.result;
                    let thinkStartIndex = resultContent.indexOf('<think>');
                    let thinkEndIndex = resultContent.indexOf('</think>');

                    // 提取 think 内容
                    let thinkContent = '';
                    let markdownContent = '';

                    if (thinkStartIndex !== -1 && thinkEndIndex !== -1) {
                        thinkContent = resultContent.slice(thinkStartIndex + 7, thinkEndIndex); // 去除 <think> 和 </think>
                        markdownContent = resultContent.slice(thinkEndIndex + 8).trim(); // 获取 think 后面的内容
                    } else {
                        markdownContent = resultContent; // 如果没有 <think> 标签，直接显示结果
                    }

                    // 更新分析结果区域
                    document.getElementById('analysis-result').innerHTML = `
                <h3>漏洞分析结果</h3>
                <h4>思考部分</h4>
                <div class="think-content">${thinkContent}</div>
                <h4>详细分析</h4>
                <div id="markdown-content">${marked(markdownContent)}</div>
            `;
                }
            })
            .catch(error => {
                console.error("分析时出错:", error);
                alert("分析时出错，请稍后再试");
            });
    }


    // 展示结果，并修改按钮状态为“重置”
    function displayResults(data) {
        let tableHTML = `
    <table class="table">
        <thead>
            <tr>
                <th>选择</th>
                <th>漏洞名称</th>
                <th>函数名称</th>
                <th>出现位置</th>
                <th>地址</th>
                <th>优先级</th>
            </tr>
        </thead>
        <tbody>
    `;

        // 遍历数据并填充到表格中
        data.forEach((item, index) => {
            tableHTML += `
        <tr>
            <td><input type="radio" name="vulfi-row" value="${item.Address}" onclick="selectRow('${item.Address}')"></td>
            <td>${item.IssueName}</td>
            <td>${item.FunctionName}</td>
            <td>${item.FoundIn}</td>
            <td>${item.Address}</td>
            <td>${item.Priority}</td>
        </tr>`;
        });
        tableHTML += "</tbody></table>";
        document.getElementById('detection-result').innerHTML = tableHTML;
    }


    let selectedAddress = null;

    // 监听单选框的选择，确保按钮状态正确
    function selectRow(address) {
        selectedAddress = address;  // 更新选中的 address
        console.log("选中的地址是:", selectedAddress);

        // 如果选中某一行，按钮应变为 "开始检测"
        if (currentStep !== 'detect') {
            document.getElementById('action-btn').textContent = '开始检测';  // 更新按钮文本
            currentStep = 'detect';  // 设置状态为 detect，表示可以开始检测
        }
    }


    // 处理文件上传并显示上传的文件
    function handleFileUpload() {
        const fileInput = document.getElementById('bin-upload');
        const file = fileInput.files[0];

        if (file) {
            // 显示上传的文件名
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('file-name').textContent = "已选择文件: " + file.name;
            };
            reader.readAsDataURL(file);

            // 修改按钮为“开始检测”
            document.getElementById('action-btn').textContent = '开始检测';
            currentStep = 'detect';  // 更新按钮状态
        } else {
            alert("请选择一个文件进行上传！");
        }
    }

    // 刷新页面
    function resetPage() {
        window.location.reload();  // 通过重载页面实现“重置”
    }
</script>
{% endblock %}
