{% extends 'base.html' %}

{% block content %}
<!-- Hero Section -->
<section id="hero" class="hero section dark-background">
    <div class="container">
        <div class="row gy-4">
            <!-- 左侧，上传文件和操作按钮 -->
            <div class="col-lg-6 order-2 order-lg-1 d-flex flex-column justify-content-center" data-aos="zoom-out">
                <h1>VULNEX</h1>
                <p>通过深度学习模型分析代码中的潜在安全漏洞</p>

                <!-- 文件上传表单 -->
                <form action="/detect" method="POST" enctype="multipart/form-data" id="detect-form"
                      class="upload-form d-flex flex-column align-items-center justify-content-center">
                    <div class="form-group w-100 d-flex">
                        <input type="file" name="bin_file" id="bin-upload" accept=".bin, .exe, .elf"
                               class="form-control w-50">
                    </div>
                </form>

                <!-- 按钮 -->
                <div class="d-flex mt-3">
                    <a href="javascript:void(0);" class="btn-get-started me-3" id="action-btn">确定选择文件</a>
                </div>
            </div>
            <!-- 显示检测结果 -->
            <div id="detection-result" style="margin-top: 20px; color: #fff;"></div>

            <!-- 右侧，示意图（可以用任何展示漏洞检测结果的图像或保留默认） -->
            <div class="col-lg-6 order-1 order-lg-2 hero-img" data-aos="zoom-out" data-aos-delay="200">
                <img id="image-display" src="../static/assets/img/hero-img.png" class="img-fluid animated"
                     alt="示意图">
                <!-- 增强后的图像，默认隐藏，改为显示检测结果 -->
                <img id="enhanced-image-display" src="" style="margin-left: 20px;" class="img-fluid animated d-none"
                     alt="检测结果">
            </div>
        </div>
    </div>
</section><!-- /Hero Section -->

<script>
    let currentStep = 'select';
    let resultData = [];  // 用于保存检测结果数据

    document.getElementById('action-btn').addEventListener('click', function (event) {
        event.preventDefault();

        if (currentStep === 'select') {
            handleFileUpload();
        } else if (currentStep === 'detect') {
            startDetection();
        } else if (currentStep === 'reset') {
            // 第三次点击“重置”
            resetPage();
        }
    });

function startDetection() {
    const formData = new FormData(document.getElementById('detect-form'));

    fetch('/detect', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log("收到的完整数据:", data);  // 调试：查看返回的完整数据

        if (data.error) {
            console.error("错误:", data.error);
            alert(data.error || "发生了未知错误");
        } else {
            // 调试：输出返回的 csv 数据
            console.log("收到的 csv 数据:", data.csv);

            // 确保 data.csv 是数组
            if (!Array.isArray(data.csv)) {
                console.error("data.csv 不是数组，数据格式错误");
                alert("数据格式错误");
                return;
            }

            // 将 VulFi 数据展示为表格
            displayResults(data.csv);

            // 修改按钮为“重置”
            document.getElementById('action-btn').textContent = '重置';
            currentStep = 'reset';  // 更新按钮状态
        }
    })
    .catch(error => {
        console.error('检测过程中出错:', error);
        alert('检测过程中出错，请稍后再试');
    });
}



function displayResults(data) {
    let tableHTML = `
    <table class="table">
        <thead>
            <tr>
                <th>漏洞名称</th>
                <th>函数名称</th>
                <th>出现位置</th>
                <th>地址</th>
                <th>优先级</th>
            </tr>
        </thead>
        <tbody>
    `;

    // 遍历 vulfi_extracted_data 并填充到表格中，去掉 Status 和 Comment 列
    data.forEach((item, index) => {
        tableHTML += `
        <tr>
            <td>${item.IssueName}</td>
            <td>${item.FunctionName}</td>
            <td>${item.FoundIn}</td>
            <td>${item.Address}</td>
            <td>${item.Priority}</td>
        </tr>`;
    });
// {
//     "Address": "0x140011e7e",
//     "Comment": "",
//     "FoundIn": "__report_securityfailureEx",
//     "FunctionName": "Loop Check",
//     "IssueName": "Unbound Loop",
//     "Priority": "High",
//     "Status": "Not Checked"
// }
    tableHTML += "</tbody></table>";
    document.getElementById('detection-result').innerHTML = tableHTML;
}



    // 处理文件上传并显示上传的文件
    function handleFileUpload() {
        const fileInput = document.getElementById('bin-upload');
        const file = fileInput.files[0];

        if (file) {
            // 显示上传的文件名
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('file-name').textContent = "已选择文件: " + file.name;
            };
            reader.readAsDataURL(file);

            // 修改按钮为“开始检测”
            document.getElementById('action-btn').textContent = '开始检测';
            currentStep = 'detect';  // 更新按钮状态
        } else {
            alert("请选择一个文件进行上传！");
        }
    }

    // 刷新页面
    function resetPage() {
        window.location.reload();  // 通过重载页面实现“重置”
    }
</script>
{% endblock %}
