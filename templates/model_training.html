{% extends 'base.html' %}

{% block content %}
<meta charset="utf-8">
<title>模型训练</title>
<section id="hero" class="hero section light-background" style="background-color: #d3e7fb">
    <div class="container">
        <!-- 页面标题 -->
        <div class="page-header mb-4">
            <h2><i class="bi bi-gpu-card"></i> 模型训练平台</h2>
            <p class="text-muted">训练和管理用于漏洞检测的深度学习模型</p>
        </div>
        <div class="row gy-4">
            <div class="col-md-12 mb-4">
                <p>通过这个平台，您可以训练和管理用于漏洞检测的深度学习模型。</p>
            </div>
            
            <!-- 左侧区域 - 训练模型 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>训练新模型</h4>
                    </div>
                    <div class="card-body">
                        <form id="modelTrainingForm">
                            <div class="mb-3">
                                <label for="modelName" class="form-label">模型名称</label>
                                <input type="text" class="form-control" id="modelName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="baseModel" class="form-label">基础模型</label>
                                <div class="d-flex">
                                    <select class="form-select me-2" id="baseModel" required>
                                        {% if models %}
                                            {% for model in models %}
                                            <option value="{{ model.name }}">{{ model.name }}</option>
                                            {% endfor %}
                                        {% else %}
                                            <option value="deepseek-r1:14b">DeepSeek-14B</option>
                                            <option value="deepseek-coder:7b">DeepSeek-Coder-7B</option>
                                            <option value="llama3:8b">Llama3-8B</option>
                                        {% endif %}
                                    </select>
                                    <button type="button" id="refresh-models-btn" class="btn btn-outline-primary" 
                                            onclick="refreshModelsList()" title="刷新模型列表">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="trainingData" class="form-label">训练数据</label>
                                <input type="file" class="form-control" id="trainingData" accept=".json,.csv">
                            </div>
                            
                            <div class="mb-3">
                                <label for="epochs" class="form-label">训练轮数</label>
                                <input type="number" class="form-control" id="epochs" min="1" max="20" value="3">
                            </div>
                            
                            <div class="mb-3">
                                <label for="learningRate" class="form-label">学习率</label>
                                <input type="number" class="form-control" id="learningRate" step="0.0001" min="0.0001" max="0.01" value="0.0002">
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100" onclick="startTraining()">开始训练</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 右侧区域 - 模型列表 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h4>已训练模型</h4>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>模型名称</th>
                                    <th>基础模型</th>
                                    <th>创建日期</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="modelsList">
                                {% if trained_models %}
                                    {% for model in trained_models %}
                                    <tr data-model-id="{{ model.id }}">
                                        <td>{{ model.model_name }}</td>
                                        <td>{{ model.base_model }}</td>
                                        <td>{{ model.created_at }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="useModel('{{ model.model_name }}')">使用</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteModel('{{ model.id }}')">删除</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">暂无训练模型</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 训练进度 -->
                <div class="card mt-4" id="trainingProgressCard" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h4>训练进度</h4>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="trainingProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="trainingStatus">等待训练...</div>
                        <div id="trainingLogs" class="mt-3 p-2 bg-light" style="max-height: 200px; overflow-y: auto; font-family: monospace;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // 刷新模型列表
    function refreshModelsList() {
        const refreshBtn = document.getElementById('refresh-models-btn');
        const modelSelect = document.getElementById('baseModel');
        
        // 添加加载动画
        refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        refreshBtn.disabled = true;
        
        fetch('/api/ollama/models')
            .then(response => response.json())
            .then(data => {
                if (data.models && Array.isArray(data.models)) {
                    // 清空现有选项
                    modelSelect.innerHTML = '';
                    
                    // 添加新选项
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });
                    
                    console.log(`已更新模型列表，共 ${data.models.length} 个模型`);
                } else {
                    console.error('获取模型列表失败');
                }
            })
            .catch(error => {
                console.error('刷新模型列表时出错:', error);
                alert('刷新模型列表失败，请稍后再试');
            })
            .finally(() => {
                // 恢复按钮状态
                refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                refreshBtn.disabled = false;
            });
    }
    
    // 使用已训练模型
    function useModel(modelName) {
        // 跳转到漏洞检测页面并选择该模型
        window.location.href = `/detective?model=${encodeURIComponent(modelName)}`;
    }
    
    // 删除已训练模型
    function deleteModel(modelId) {
        if (!confirm('确定要删除该模型吗？')) {
            return;
        }
        
        fetch(`/api/models/trained/${modelId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 从DOM中移除该行
                const row = document.querySelector(`tr[data-model-id="${modelId}"]`);
                if (row) {
                    row.remove();
                }
                // 如果没有模型了，显示提示
                if (document.getElementById('modelsList').children.length === 0) {
                    document.getElementById('modelsList').innerHTML = 
                        '<tr><td colspan="4" class="text-center">暂无训练模型</td></tr>';
                }
            } else {
                alert(data.error || '删除失败');
            }
        })
        .catch(error => {
            console.error('删除模型时出错:', error);
            alert('删除模型失败，请稍后再试');
        });
    }
    
    // 更新已训练模型列表
    function refreshTrainedModels() {
        fetch('/api/models/trained')
        .then(response => response.json())
        .then(data => {
            if (data.models) {
                const modelsList = document.getElementById('modelsList');
                
                // 清空现有列表
                modelsList.innerHTML = '';
                
                if (data.models.length === 0) {
                    modelsList.innerHTML = '<tr><td colspan="4" class="text-center">暂无训练模型</td></tr>';
                    return;
                }
                
                // 添加模型到列表
                data.models.forEach(model => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-model-id', model.id);
                    
                    row.innerHTML = `
                        <td>${model.model_name}</td>
                        <td>${model.base_model}</td>
                        <td>${model.created_at}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="useModel('${model.model_name}')">使用</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteModel('${model.id}')">删除</button>
                        </td>
                    `;
                    
                    modelsList.appendChild(row);
                });
            }
        })
        .catch(error => {
            console.error('获取训练模型列表时出错:', error);
        });
    }

    function startTraining() {
        // 获取表单数据
        const modelName = document.getElementById('modelName').value;
        const baseModel = document.getElementById('baseModel').value;
        const epochs = document.getElementById('epochs').value;
        
        // 表单验证
        if (!modelName) {
            alert('请输入模型名称');
            return;
        }
        
        // 显示训练进度卡片
        document.getElementById('trainingProgressCard').style.display = 'block';
        document.getElementById('trainingProgress').style.width = '0%';
        document.getElementById('trainingStatus').textContent = '准备训练...';
        document.getElementById('trainingLogs').innerHTML = '> 初始化训练环境...\n';
        
        // 模拟训练进度
        let progress = 0;
        const trainingInterval = setInterval(() => {
            progress += 5;
            if (progress > 100) {
                clearInterval(trainingInterval);
                document.getElementById('trainingStatus').textContent = '训练完成!';
                document.getElementById('trainingLogs').innerHTML += '> 训练完成! 模型已保存。\n';
                
                // 保存训练好的模型信息到服务器
                saveTrainedModel(modelName, baseModel);
                
                return;
            }
            
            document.getElementById('trainingProgress').style.width = `${progress}%`;
            document.getElementById('trainingStatus').textContent = `训练中... ${progress}%`;
            
            // 添加一些模拟的训练日志
            if (progress % 20 === 0) {
                document.getElementById('trainingLogs').innerHTML += `> 训练第 ${progress/20} 轮, 损失值: ${(5 - progress/25).toFixed(4)}\n`;
                document.getElementById('trainingLogs').scrollTop = document.getElementById('trainingLogs').scrollHeight;
            }
        }, 500);
    }
    
    // 保存训练好的模型信息
    function saveTrainedModel(modelName, baseModel) {
        const modelData = {
            model_name: modelName,
            base_model: baseModel,
            created_at: new Date().toISOString().slice(0, 10),
            epochs: document.getElementById('epochs').value,
            learning_rate: document.getElementById('learningRate').value
        };
        
        fetch('/api/models/trained', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(modelData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('模型保存成功:', data.model);
                
                // 刷新已训练模型列表
                refreshTrainedModels();
            } else {
                console.error('模型保存失败:', data.error);
                alert('模型保存失败: ' + (data.error || '未知错误'));
            }
        })
        .catch(error => {
            console.error('保存模型时出错:', error);
            alert('保存模型信息失败，请稍后再试');
        });
    }
    
    // 页面加载完成后检查URL参数是否需要刷新模型列表
    document.addEventListener('DOMContentLoaded', function() {
        // 如果URL中有refresh=true参数，刷新模型列表
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('refresh') === 'true') {
            refreshModelsList();
            refreshTrainedModels();
        }
    });
</script>
{% endblock %} 